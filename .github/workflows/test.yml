name: Test Formula

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test-formula:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Homebrew
        id: set-up-homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Create local tap
        run: |
          # Crear directorio del tap con nombre temporal para testing
          mkdir -p $(brew --repository)/Library/Taps/cpcready/homebrew-cpcready-test

          # Copiar la fórmula al tap temporal
          cp -r ${{ github.workspace }}/Formula $(brew --repository)/Library/Taps/cpcready/homebrew-cpcready-test/

          # Crear un .git vacío para que Homebrew lo reconozca como tap
          cd $(brew --repository)/Library/Taps/cpcready/homebrew-cpcready-test
          git init
          git config user.email "test@test.com"
          git config user.name "Test"
          git add .
          git commit -m "Test formula"

      - name: Install formula
        run: |
          brew install cpcready-test/cpc

      - name: Test installation
        run: |
          # Verificar que el comando existe
          which cpc

          # Verificar la versión
          cpc --version

          # Verificar la ayuda
          cpc --help

      - name: Run Homebrew tests
        run: |
          brew test cpcready-test/cpc

      - name: Audit formula
        run: |
          brew audit --strict cpcready-test/cpc

      - name: Check formula style
        run: |
          brew style cpcready-test/cpc

      - name: Cleanup
        if: always()
        continue-on-error: true
        run: |
          # Desinstalar la fórmula usando el nombre completo
          brew uninstall cpcready-test/cpc 2>/dev/null || true

          # Eliminar el tap temporal
          brew untap cpcready/cpcready-test 2>/dev/null || true

          # Limpiar cache de Homebrew
          brew cleanup 2>/dev/null || true
